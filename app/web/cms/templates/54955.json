{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  const {\n    tanggal_waktu_percakapan,\n    isi_percakapan,\n    ticket_status,\n    attachment,\n    id_history_ticket,\n    id_user,\n    id_employee,\n  } = req.body;\n\n  const ticket = await db.history_ticket.findUnique({\n    where: {\n      id_history_ticket,\n    },\n    include: {\n      client: {\n        include: {\n          users: true,\n        },\n      },\n      employee: {\n        include: {\n          users: true,\n        },\n      },\n    },\n  });\n\n  if (id_employee !== null) {\n    if (ticket_status === \"ASSIGNED\") {\n      var timeDifference = ext.minutesDifference(\n        tanggal_waktu_percakapan,\n        ticket.tanggalAssign_ticket\n      );\n\n      await db.history_ticket.update({\n        where: {\n          id_history_ticket,\n        },\n        data: {\n          id_employee,\n          id_status_ticket: 3,\n          tanggalProgress_ticket: tanggal_waktu_percakapan,\n          firstReply_deviation: timeDifference,\n        },\n      });\n    }\n  }\n\n  await db.percakapan.create({\n    data: {\n      tanggal_waktu_percakapan: tanggal_waktu_percakapan,\n      isi_percakapan,\n      attachment,\n      id_history_ticket,\n      id_user,\n    },\n  });\n\n  if (ticket_status !== \"OPEN\" && ticket_status !== \"ASSIGNED\") {\n    if (user.user.role === \"Client\") {\n      await db.notifikasi.create({\n        data: {\n          id_historyTicket: id_history_ticket,\n          status_notifications: \"Diterima\",\n          type_notification: \"Message\",\n          date_notification: tanggal_waktu_percakapan,\n          id_user: ticket.employee?.id_user,\n        },\n      });\n    }\n  }\n\n  if (user.user.role === \"Employee\") {\n    await db.notifikasi.create({\n      data: {\n        id_historyTicket: id_history_ticket,\n        status_notifications: \"Diterima\",\n        type_notification: \"Message\",\n        date_notification: tanggal_waktu_percakapan,\n        id_user: ticket.client?.id_user,\n      },\n    });\n  }\n  reply.send({\n    status: \"SUCCESS\",\n    message: \"Berhasil tambah data\",\n  })\n}","figma":{}},"title":"add-message","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"66283","slug":"/api/message","site":"*","id":"54955"}